<head>
	<link rel="stylesheet" type="text/css" href="styles.css" />
	<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>

<body class="flex-grid"></body>

<script type="text/javascript">
	const DEFAULT_TEXT = '#EXTM3U\n#EXT-X-VERSION:3\n';

	const REFRESH_INTERVAL = 10; // seconds
	let liveCourses = [];
	let courses = ['beta', 'beta', 'beta', 'beta'];

	const spawnStream = courseCode => {
		const video = document.createElement('video');
		video.className = 'col';
		video.setAttribute('controls', true);

		const videoSrc =
			'https://live.uia.no/live/ngrp:' +
			courseCode +
			'_all/playlist.m3u8';

		const hls = new Hls();
		hls.loadSource(videoSrc);
		hls.attachMedia(video);
		hls.on(Hls.Events.MANIFEST_PARSED, () => {
			video.play();
		});

		document.body.appendChild(video);
	};

	const isLive = async courseCode => {
		const resp = await fetch(
			`https://live.uia.no/live/ngrp:${courseCode}_all/playlist.m3u8`
		);
		const blob = await resp.blob();
		const text = await blob.text();

		return text !== DEFAULT_TEXT;
	};

	const checkStreams = async () => {
		let currentCourses = [];

		await Promise.all(
			courses.map(async courseCode => {
				if (await isLive(courseCode)) {
					currentCourses.push(courseCode);
				}
			})
		);

		if (!currentCourses.every(val => liveCourses.includes(val))) {
			liveCourses = currentCourses;

			document.body.innerHTML = '';
			liveCourses.map(courseCode => spawnStream(courseCode));
		}

		if (liveCourses.length === 0) {
			document.body.innerHTML = 'No streams live at the moment';
		}

		setTimeout(async () => {
			await checkStreams();
		}, REFRESH_INTERVAL * 1000);
	};

	checkStreams();
</script>
